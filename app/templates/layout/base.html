<!DOCTYPE html>
<html lang="it">
<script>
(function() {
  const STORAGE_KEY = "theme-preference";

  function applyTheme(theme) {
    if (theme === "system") {
      document.documentElement.removeAttribute("data-theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");
    } else {
      document.documentElement.setAttribute("data-theme", theme);
    }
  }

  const saved = localStorage.getItem(STORAGE_KEY) || "system";
  applyTheme(saved);

  // aggiorna se il sistema cambia tema e l’utente ha scelto "system"
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
    if ((localStorage.getItem(STORAGE_KEY) || "system") === "system") {
      applyTheme("system");
    }
  });
})();
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta property="og:title" content="{{ item.title if item else 'Volò' }}">
  <meta property="og:description" content="{{ item.description if item else 'Scopri eventi e campagne' }}">
  <meta property="og:image" content="{{ url_for('events.static', filename='uploads/events/' ~ item.image_filename, _external=True) if item and item.image_filename else url_for('static', filename='img/logo.png', _external=True) }}">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ item.title if item else 'Volò' }}">
  <meta name="twitter:description" content="{{ item.description if item else 'Scopri eventi e campagne' }}">
  <meta name="twitter:image" content="{{ url_for('events.static', filename='uploads/events/' ~ item.image_filename, _external=True) if item and item.image_filename else url_for('static', filename='img/logo.png', _external=True) }}">
  
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">

  <title>{% block title %}Volontariato Digitale{% endblock %}</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- Stili personalizzati -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/events.css') }}">

  {% block head %}{% endblock %}
</head>

<div id="cookie-banner" class="cookie-banner d-none">
  <div class="cookie-content">
    <p>
        {{ _('Utilizziamo cookie tecnici necessari al funzionamento della Piattaforma e, previo consenso,
      cookie analitici e di profilazione per migliorare i servizi. Per saperne di più consulta la') }}
       <a href="{{ url_for('public.privacy') }}" target="_blank">Cookie Policy</a>.
    </p>
    <div class="cookie-actions">
      <button class="btn btn-sm btn-success me-2" id="cookie-accept">{{ _('Accetta') }}</button>
      <button class="btn btn-sm btn-outline-secondary me-2" id="cookie-reject">{{ _('Rifiuta') }}</button>
      <button class="btn btn-sm btn-primary" id="cookie-settings">{{ _('Impostazioni') }}</button>
    </div>
  </div>
</div>

<!-- Modal impostazioni -->
<div class="modal fade" id="cookieSettingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Preferenze Cookie') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Chiudi') }}"></button>
      </div>
      <div class="modal-body">
        <form id="cookie-preferences">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="cookie-analytics">
            <label class="form-check-label" for="cookie-analytics">
              {{ _('Cookie analitici (statistiche anonime)') }}
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="cookie-marketing">
            <label class="form-check-label" for="cookie-marketing">
              {{ _('Cookie di profilazione/marketing') }}
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">{{ _('Chiudi') }}</button>
        <button type="button" class="btn btn-success btn-sm" id="save-preferences">{{ _('Salva preferenze') }}</button>
      </div>
    </div>
  </div>
</div>


<body class="{% block body_class %}{% endblock %}">
  
  {% include 'partials/navbar.html' %}


  <main class="{% block container_class %}container container-wider{% endblock %} mt-4">
    {% block content %}{% endblock %}
  </main>

  {% include 'partials/footer.html' %}


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  {% block scripts %}
  <script>
document.addEventListener("DOMContentLoaded", function () {
  const banner = document.getElementById("cookie-banner");
  const acceptBtn = document.getElementById("cookie-accept");
  const rejectBtn = document.getElementById("cookie-reject");
  const settingsBtn = document.getElementById("cookie-settings");
  const saveBtn = document.getElementById("save-preferences");
  const analyticsChk = document.getElementById("cookie-analytics");
  const marketingChk = document.getElementById("cookie-marketing");

  // Leggi preferenze salvate
  const prefs = JSON.parse(localStorage.getItem("cookie_prefs"));
  if (!prefs) {
    banner.classList.remove("d-none"); // Mostra banner solo se non ci sono preferenze salvate
  }

  acceptBtn?.addEventListener("click", () => {
    localStorage.setItem("cookie_prefs", JSON.stringify({ analytics: true, marketing: true }));
    banner.classList.add("d-none");
    location.reload(); // ricarica per applicare
  });

  rejectBtn?.addEventListener("click", () => {
    localStorage.setItem("cookie_prefs", JSON.stringify({ analytics: false, marketing: false }));
    banner.classList.add("d-none");
  });

  settingsBtn?.addEventListener("click", () => {
    const modal = new bootstrap.Modal(document.getElementById("cookieSettingsModal"));
    modal.show();
  });

  saveBtn?.addEventListener("click", () => {
    const prefs = {
      analytics: analyticsChk.checked,
      marketing: marketingChk.checked,
    };
    localStorage.setItem("cookie_prefs", JSON.stringify(prefs));
    banner.classList.add("d-none");
    const modal = bootstrap.Modal.getInstance(document.getElementById("cookieSettingsModal"));
    modal.hide();
  });
});
  </script>

  {% endblock %}
</body>

</html>
