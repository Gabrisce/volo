{% extends 'layout/base.html' %}
{% block title %}Home{% endblock %}
{% block container_class %}container-xl{% endblock %}


{#  AGGIUNGI QUESTO: classe solo per home #}
{% block body_class %}home-body{% endblock %}

{% block content %}
<div class="row justify-content-center gy-4">
  {# ===================== BARRA RICERCA (versione pill) ===================== #}
      <form method="GET" action="{{ url_for('home.home') }}" class="mb-3" role="search" aria-label="{{ _('Cerca') }}">
        <div class="search-wrapper">
          <div class="input-group input-group-sm align-items-stretch search-inputgroup">
            <label class="visually-hidden" for="q">{{ _('Cerca') }}</label>

            <span class="input-group-text search-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
                <line x1="20" y1="20" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>

            <input id="q" type="text" name="q" class="form-control form-control-sm search-input"
                   placeholder="{{ _('Cerca per titolo, descrizione o luogo...') }}"
                   value="{{ request.args.get('q', '') }}" autocomplete="off" />

            <button class="btn btn-search" type="submit" aria-label="{{ _('Cerca') }}">
              {{ _('Cerca') }}
            </button>
          </div>
        </div>
      </form>

  <!-- Colonna centrale (centrata) -->
  <div class="col-12 col-lg-8 col-xl-7">
    <section class="d-flex flex-column home-center">


      {# ------------------ RISULTATI: Associazioni PRIMA del feed (solo se q) ------------------ #}
      {% if found_associations and request.args.get('q') %}
        <div class="search-results mb-4">
          <h6 class="mb-2">{{ _('Associazioni trovate') }}</h6>
          <div class="row g-2">
            {% for assoc in found_associations %}
              <div class="col-12">
                <a href="{{ url_for('public.public_profile', association_id=assoc.id) }}"
                   class="d-flex align-items-center p-2 border rounded-3 text-decoration-none hover-shadow"
                   style="gap:.75rem;">
                  <img class="rounded-circle" width="36" height="36"
                       src="{% if assoc.photo_filename %}
                              {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ assoc.photo_filename) }}
                            {% else %}
                              {{ url_for('static', filename='img/avatar-placeholder.png') }}
                            {% endif %}"
                       alt="Logo {{ assoc.name }}">
                  <div class="d-flex flex-column">
                    <strong class="text-body">{{ assoc.name }}</strong>
                  </div>
                </a>
              </div>
            {% endfor %}
          </div>
          <hr class="my-3">
        </div>
      {% endif %}
      {# ----------------------------- FEED DINAMICO ----------------------------- #}
      {% if feed_items %}
        <div class="feed-container">
          {% for entry in feed_items %}

            {# ====== EVENTO ====== #}
            {% if entry.type == 'event' %}
              {% set event = entry.item %}
              <article class="card shadow-sm mb-3 feed-card">
                <div class="type-badge type-event"></div>
                <div class="card-body position-relative">
                  <h5 class="card-title mb-1">
                    <a href="{{ url_for('public.detail', content_type='event', item_id=event.id) }}" class="text-decoration-none text-dark-green">
                      {{ event.title }}
                    </a>
                  </h5>

                  <p class="organizer mb-1 d-flex align-items-center">
                    {{ _('organizzato da') }}
                    <a href="{{ url_for('public.public_profile', association_id=event.association.id) }}"
                       class="text-decoration-none text-dark-green d-inline-flex align-items-center ms-1">
                      {{ event.association.name }}
                      <img
                        class="rounded-circle avatar-xs me-1"
                        src="{% if event.association.photo_filename %}
                                {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ event.association.photo_filename) }}
                              {% else %}
                                {{ url_for('static', filename='img/avatar-placeholder.png') }}
                              {% endif %}"
                        alt="Logo {{ event.association.name }}">
                    </a>
                  </p>

                  <small class="text-muted d-block mb-2">
                    {% if event.date %}{{ event.date.strftime('%d/%m/%Y') }} – {% endif %}{{ event.location or 'Luogo non indicato' }}
                  </small>

                  {% if event.description %}
                    <p class="card-text clamp" data-clamp="4">{{ event.description }}</p>
                  {% endif %}

                  {% if event.image_filename %}
                    <div class="thumb-top-right">
                      <a href="{{ url_for('events.static', filename='uploads/events/' ~ event.image_filename) }}" target="_blank">
                        <img src="{{ url_for('events.static', filename='uploads/events/' ~ event.image_filename) }}"
                             alt="Immagine evento"
                             class="thumb-img">
                      </a>
                    </div>
                  {% endif %}

                  <button type="button" class="toggle-card d-none">{{ _('Mostra altro') }}</button>
                </div>
              </article>

            {# ====== POST ====== #}
            {% elif entry.type == 'post' %}
              {% set post = entry.item %}
              <article class="card shadow-sm mb-3 feed-card">
                <div class="type-badge type-post"></div>
                <div class="card-body position-relative">

                  <!-- Titolo con avatar + nome associazione -->
                  <div class="d-flex align-items-center mb-1">
                    <a href="{{ url_for('public.public_profile', association_id=post.association.id) }}"
                       class="text-decoration-none d-inline-flex align-items-center">
                      <span class="h6 mb-0 text-dark-green">{{ post.association.name }}</span>
                      <img
                        class="rounded-circle avatar-xs me-1"
                        src="{% if post.association.photo_filename %}
                                {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ post.association.photo_filename) }}
                              {% else %}
                                {{ url_for('static', filename='img/avatar-placeholder.png') }}
                              {% endif %}"
                        alt="Logo {{ post.association.name }}">
                    </a>
                  </div>
                  <small class="text-muted d-block mb-2">{{ _('Pubblicato il') }} {{ entry.timestamp.strftime('%d/%m/%Y') }}</small>

                  <h6 class="card-title pe-5">
                    <a href="{{ url_for('posts.post_detail', post_id=post.id) }}"
                       class="text-decoration-none text-dark">
                      {{ post.title or "Titolo mancante" }}
                    </a>
                  </h6>

                  {% if post.content %}
                    <p class="card-text clamp" data-clamp="4">{{ post.content }}</p>
                  {% endif %}

                  {% if post.image_filename %}
                    <div class="thumb-top-right">
                      <a href="{{ url_for('posts.static', filename='uploads/posts/' ~ post.image_filename) }}" target="_blank">
                        <img src="{{ url_for('posts.static', filename='uploads/posts/' ~ post.image_filename) }}"
                             alt="Immagine post"
                             class="thumb-img">
                      </a>
                    </div>
                  {% endif %}

                  <div><button type="button" class="toggle-card d-none">{{ _('Mostra altro') }}</button></div>

                  {% set applause_count = post.applause|length if post.applause is defined else 0 %}
                  {% set user_has_applauded = current_user.is_authenticated and post.applause|selectattr("user_id","equalto",current_user.id)|list|length > 0 %}
                  <button type="button"
                      class="applause-btn d-inline-flex align-items-center {% if user_has_applauded %}active{% endif %} mt-2"
                      data-post-id="{{ post.id }}">
                    <svg class="applause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                      <path d="M368 16V80c0 8.8-7.2 16-16 16s-16-7.2-16-16V16c0-8.8 
                              7.2-16 16-16s16 7.2 16 16zm-98.7 7.1l32 48c4.9 7.4 
                              2.9 17.3-4.4 22.2s-17.3 2.9-22.2-4.4l-32-48c-4.9-7.4 
                              2.9-17.3 4.4-22.2s17.3-2.9 22.2 4.4zM167 119c9.4-9.4 
                              24.6-9.4 33.9 0L324.7 242.7c10.1 10.1 27.3 2.9 
                              27.3-11.3V192c0-17.7 14.3-32 32-32s32 14.3 
                              32 32V345.6c0 57.1-30 110-78.9 139.4c-64 
                              38.4-145.8 28.3-198.5-24.4L39 361c-9.4-9.4-9.4-24.6 
                              0-33.9s24.6-9.4 33.9 0l53 53c6.1 6.1 16 6.1 
                              22.1 0s6.1-16 0-22.1L55 265c-9.4-9.4-9.4-24.6 
                              0-33.9s24.6-9.4 33.9 0l93 93c6.1 6.1 16 6.1 
                              22.1 0s6.1-16 0-22.1L87 185c-9.4-9.4-9.4-24.6 
                              0-33.9s24.6-9.4 33.9 0l117 117c6.1 6.1 16 6.1 
                              22.1 0s6.1-16 0-22.1l-93-93c-9.4-9.4-9.4-24.6 
                              0-33.9zM465.1 484.9c-24.2 14.5-50.9 22.1-77.7 
                              23.1c48.1-39.6 76.6-99 76.6-162.4l0-98.1c8.2-.1 
                              16-6.4 16-16V192c0-17.7 14.3-32 32-32s32 14.3 
                              32 32V345.6c0 57.1-30 110-78.9 139.4zM456.9 
                              18.7c7.4 4.9 9.3 14.8 4.4 22.2l-32 48c-4.9 
                              7.4-14.8 9.3-22.2 4.4s-9.3-14.8-4.4-22.2l32-48c4.9-7.4 
                              14.8-9.3 22.2-4.4z"/>
                    </svg>
                    <span class="applause-count ms-1">{{ applause_count }}</span>
                  </button>
                </div>
              </article>

            {# ====== CAMPAGNA ====== #}
            {% elif entry.type == 'campaign' %}
              {% set campaign = entry.item %}
              <article class="card shadow-sm mb-3 feed-card">
                <div class="type-badge type-campaign"></div>
                <div class="card-body position-relative">
                  <h5 class="card-title mb-1">
                    <a href="{{ url_for('public.detail', content_type='campaign', item_id=campaign.id) }}" class="text-decoration-none text-dark-green">
                      {{ campaign.title }}
                    </a>
                  </h5>

                  <p class="organizer mb-1 d-flex align-items-center">
                    {{ _('organizzato da') }}
                    <a href="{{ url_for('public.public_profile', association_id=campaign.association.id) }}"
                       class="text-decoration-none text-dark-green d-inline-flex align-items-center ms-1">
                      {{ campaign.association.name }}
                      <img
                        class="rounded-circle avatar-xs me-1"
                        src="{% if campaign.association.photo_filename %}
                                {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ campaign.association.photo_filename) }}
                              {% else %}
                                {{ url_for('static', filename='img/avatar-placeholder.png') }}
                              {% endif %}"
                        alt="Logo {{ campaign.association.name }}">
                    </a>
                  </p>
                  <small class="text-muted d-block mb-2">{{ _('Pubblicato il') }} {{ entry.timestamp.strftime('%d/%m/%Y') }}</small>

                  {% if campaign.description %}
                    <p class="card-text clamp" data-clamp="4">{{ campaign.description }}</p>
                  {% endif %}

                  {% if campaign.image_filename %}
                    <div class="thumb-top-right">
                      <a href="{{ url_for('campaigns.static', filename='uploads/campaigns/' ~ campaign.image_filename) }}" target="_blank">
                        <img src="{{ url_for('campaigns.static', filename='uploads/campaigns/' ~ campaign.image_filename) }}"
                             alt="Immagine campaign"
                             class="thumb-img">
                      </a>
                    </div>
                  {% endif %}

                  <button type="button" class="toggle-card d-none">{{ _('Mostra altro') }}</button>
                </div>
              </article>
            {% endif %}

          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">{{ _('Nessun risultato trovato') }}{% if request.args.get('q') %} per “{{ request.args.get('q') }}”{% endif %}</p>
      {% endif %}
    </section>
  </div>



  <!-- Colonna destra: Petizioni + Associazioni (sticky stack) -->
<div class="col-12 col-lg-4 d-none d-lg-block">
  <div class="right-rail">
    <!-- Petizioni -->
    <aside class="petitions-panel card shadow-sm border-0">
      <div class="petitions-header d-flex align-items-center justify-content-between">
        <h6 class="mb-0">{{ _('Petizioni recenti') }}</h6>
      </div>
      <div class="petitions-body">
        <ul class="list-unstyled m-0">
          {% for petition in petitions %}
            <li class="petition-item">
              <a href="{{ url_for('petitions.petition_detail', petition_id=petition.id) }}"
                 class="petition-link">
                <div class="petition-meta">
                  <h6 class="petition-title">{{ petition.title }}</h6>
                  <div class="petition-info">
                    {{ petition.created_at.strftime("%d/%m/%Y") }}
                    {% if petition.location %} · 📍 {{ petition.location }}{% endif %}
                  </div>
                  {% if petition.description %}
                    <p class="petition-desc desc-text" data-full="{{ petition.description }}">
                      {{ petition.description[:140] }}{% if petition.description|length > 140 %}… <span class="toggle-desc link-like">Mostra altro</span>{% endif %}
                    </p>
                  {% endif %}
                </div>

                {% if petition.image_filename %}
                  <div class="petition-thumb">
                    <img src="{{ url_for('petitions.static', filename='uploads/petitions/' ~ petition.image_filename) }}"
                         alt="Immagine petizione" loading="lazy">
                  </div>
                {% endif %}
              </a>
            </li>
          {% else %}
            <li class="text-muted small px-3 py-2">{{ _('Nessuna petizione attiva') }}</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- Associazioni vicine (orizzontale) -->
    <aside class="associations-panel card shadow-sm border-0" aria-labelledby="assocTitle">
      <div class="petitions-header d-flex align-items-center justify-content-between">
        <h6 id="assocTitle" class="mb-0">{{ _('Scopri chi popola la piattaforma') }}</h6>
        <a class="small text-decoration-none" href="{{ url_for('public.list_associations') }}">
          {{ _('Vedi tutte') }}
        </a>
      </div>

      <div class="associations-body position-relative">
        <button class="hs-arrow hs-prev" type="button" aria-label="{{ _('Scorri a sinistra') }}" tabindex="0"></button>

        <div class="associations-scroller" id="associationsScroller"
             role="region" aria-label="{{ _('Associazioni vicine') }}" tabindex="0">
          {% for a in associations %}
            <a class="assoc-card" href="{{ url_for('public.public_profile', association_id=a.id) }}"
               data-lat="{{ a.latitude or '' }}" data-lng="{{ a.longitude or '' }}">
              <div class="assoc-avatar-wrap">
                <img class="assoc-avatar"
                     src="{% if a.photo_filename %}{{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ a.photo_filename) }}{% else %}{{ url_for('static', filename='img/avatar-placeholder.png') }}{% endif %}"
                     alt="Logo {{ a.name }}">
              </div>
              <div class="assoc-meta">
                <span class="assoc-name text-truncate">{{ a.name }}</span>
                <span class="assoc-distance" aria-hidden="true"></span>
              </div>
            </a>
          {% endfor %}
        </div>

        <button class="hs-arrow hs-next" type="button" aria-label="{{ _('Scorri a destra') }}" tabindex="0"></button>
      </div>
    </aside>
  </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/events.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // === Gestione Mostra Altro / Mostra Meno ===
  document.querySelectorAll('.feed-card').forEach(function(card){
    const text = card.querySelector('.clamp');
    const media = card.querySelector('.clamp-media');
    const btn = card.querySelector('.toggle-card');

    let needsToggle = false;
    if (text && (text.innerText || '').trim().length > 300) needsToggle = true;
    if (media) needsToggle = true;

    if (needsToggle && btn) {
      btn.classList.remove('d-none');
      btn.addEventListener('click', function(){
        card.classList.toggle('expanded');
        btn.textContent = card.classList.contains('expanded') ? 'Mostra meno' : 'Mostra altro';
      });
    }
  });
});

document.addEventListener("DOMContentLoaded", function(){
  document.querySelectorAll(".toggle-desc").forEach(link=>{
    link.addEventListener("click", function(e){
      e.preventDefault();
      const p = this.closest(".desc-text");
      const full = p.dataset.full;
      const short = full.slice(0,160);

      if (p.classList.contains("expanded")) {
        p.innerHTML = short + '... <a href="#" class="toggle-desc">Mostra altro</a>';
        p.classList.remove("expanded");
      } else {
        p.innerHTML = full + ' <a href="#" class="toggle-desc">Mostra meno</a>';
        p.classList.add("expanded");
      }
      p.querySelector(".toggle-desc").addEventListener("click", arguments.callee);
    });
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.thumb-img').forEach(img => {
    img.addEventListener('click', (e) => {
      e.preventDefault();
      const src = img.closest('a').href;

      const overlay = document.createElement("div");
      overlay.style.position = "fixed";
      overlay.style.top = 0;
      overlay.style.left = 0;
      overlay.style.width = "100%";
      overlay.style.height = "100%";
      overlay.style.background = "rgba(0,0,0,0.85)";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.zIndex = 9999;
      overlay.style.cursor = "zoom-out";

      const bigImg = document.createElement("img");
      bigImg.src = src;
      bigImg.style.maxWidth = "90%";
      bigImg.style.maxHeight = "90%";
      bigImg.style.borderRadius = "8px";
      bigImg.style.boxShadow = "0 4px 20px rgba(0,0,0,0.5)";

      overlay.appendChild(bigImg);
      overlay.addEventListener("click", () => overlay.remove());

      document.body.appendChild(overlay);
    });
  });
});

/* --- Horizontal scroll + keyboard --- */
document.addEventListener('DOMContentLoaded', () => {
  const scroller = document.getElementById('associationsScroller');
  if (!scroller) return;

  const prev = scroller.parentElement.querySelector('.hs-prev');
  const next = scroller.parentElement.querySelector('.hs-next');

  const STEP = Math.max(scroller.clientWidth * 0.9, 320); // ~una viewport per click

  function doScroll(dx) { scroller.scrollBy({ left: dx, behavior: 'smooth' }); }
  prev?.addEventListener('click', () => doScroll(-STEP));
  next?.addEventListener('click', () => doScroll(+STEP));

  // tastiera: frecce sx/dx scorrono il carosello quando ha focus
  scroller.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') { e.preventDefault(); doScroll(+STEP); }
    if (e.key === 'ArrowLeft')  { e.preventDefault(); doScroll(-STEP); }
  });
});

/* --- Distanza utente -> associazioni (Haversine) + ordinamento DOM --- */
document.addEventListener('DOMContentLoaded', () => {
  const scroller = document.getElementById('associationsScroller');
  if (!scroller) return;

  const cards = Array.from(scroller.querySelectorAll('.assoc-card'));

  // get user location: 1) geoloc 2) eventuale lat/lng in body data-* (se lo aggiungi) 3) fallback: no sort
  function getUserCoords() {
    return new Promise((resolve) => {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          ()   => resolve(null), // rifiutata o errore
          { enableHighAccuracy: false, timeout: 5000, maximumAge: 600000 }
        );
      } else {
        resolve(null);
      }
    });
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 6371; // km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function formatKm(km) {
    if (!isFinite(km)) return '';
    if (km < 1) return `${Math.round(km*1000)} m`;
    if (km < 50) return `${km.toFixed(1)} km`;
    return `${Math.round(km)} km`;
  }

  (async () => {
    const me = await getUserCoords();
    if (!me) return; // niente sorting, mostriamo l'ordine predefinito

    // calcola distanze dove disponibili, poi ordina DOM
    const withDist = cards.map(card => {
      const lat = parseFloat(card.dataset.lat);
      const lng = parseFloat(card.dataset.lng);
      const has = isFinite(lat) && isFinite(lng);
      const dist = has ? haversine(me.lat, me.lng, lat, lng) : Number.POSITIVE_INFINITY;
      return { card, dist, has };
    });

    // ordina: prima chi ha coordinate, by distanza asc; poi senza coordinate
    withDist.sort((a,b) => a.dist - b.dist);

    // aggiorna etichetta distanza e riordina nel DOM
    withDist.forEach(({ card, dist, has }) => {
      const label = card.querySelector('.assoc-distance');
      if (label) label.textContent = has ? formatKm(dist) : '';
      scroller.appendChild(card);
    });
  })();
});
</script>

<script src="{{ url_for('static', filename='js/applause.js') }}"></script>





{% endblock %}
