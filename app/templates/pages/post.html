{% extends 'layout/base.html' %}

{% block title %}{{ post.title }} - Post{% endblock %}

{% block content %}
<div class="container" style="margin-top:0.5rem;">

  <!-- 🔙 Torna indietro -->
 <div style="margin-bottom:8px;">
  <a href="{{ request.referrer or url_for('home.home') }}" 
     aria-label="Torna alla pagina precedente"
     style="color:#006400; font-weight:600; font-size:0.95rem; text-decoration:none;">
    <i class="bi bi-arrow-left" style="margin-right:4px;"></i> {{ _('Indietro') }}
  </a>
</div>


<article class="card shadow-sm p-4 text-center position-relative">
    <h3 class="mb-2">{{ post.title }}</h3>

    {% if post.association %}
      <p class="small text-muted mb-2">
        <a href="{{ url_for('public.public_profile', association_id=post.association.id) }}" 
           class="text-decoration-none text-dark-green">
          {% if post.association.photo_filename %}
            <img src="{{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ post.association.photo_filename) }}"
                 class="rounded-circle avatar-20 me-1" alt="Logo {{ post.association.name }}">
          {% endif %}
          {{ post.association.name }}
        </a>
      </p>
    {% endif %}

    <p class="text-muted mb-2">
      Pubblicato il {{ post.created_at.strftime("%d/%m/%Y %H:%M") }}
    </p>

    <!-- Descrizione -->
    <div class="mt-2 text-start">
      {{ post.content | safe }}
    </div>

    {% if post.image_filename %}
      <div class="mb-3">
        <img src="{{ url_for('posts.static', filename='uploads/posts/' ~ post.image_filename) }}"
             class="img-fluid rounded" alt="Immagine del post">
      </div>
    {% endif %}

    <!-- ⭐ Applausi -->
    {% set applause_count = post.applause|length if post.applause is defined else 0 %}
    {% set user_has_applauded = current_user.is_authenticated and post.applause|selectattr("user_id","equalto",current_user.id)|list|length > 0 %}
    <div class="mt-3 d-flex justify-content-center">
      <button type="button"
              class="applause-btn d-inline-flex align-items-center {% if user_has_applauded %}active{% endif %}"
              data-post-id="{{ post.id }}">
        <svg class="applause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
          <path d="M368 16V80c0 8.8-7.2 16-16 16s-16-7.2-16-16V16c0-8.8 7.2-16 16-16s16 7.2 16 16zm-98.7 7.1l32 48c4.9 7.4 2.9 17.3-4.4 22.2s-17.3 2.9-22.2-4.4l-32-48c-4.9-7.4-2.9-17.3 4.4-22.2s17.3-2.9 22.2 4.4zM167 119c9.4-9.4 24.6-9.4 33.9 0L324.7 242.7c10.1 10.1 27.3 2.9 27.3-11.3V192c0-17.7 14.3-32 32-32s32 14.3 32 32V345.6c0 57.1-30 110-78.9 139.4c-64 38.4-145.8 28.3-198.5-24.4L39 361c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l53 53c6.1 6.1 16 6.1 22.1 0s6.1-16 0-22.1L55 265c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l93 93c6.1 6.1 16 6.1 22.1 0s6.1-16 0-22.1l-93-93c-9.4-9.4-9.4-24.6 0-33.9zM465.1 484.9c-24.2 14.5-50.9 22.1-77.7 23.1c48.1-39.6 76.6-99 76.6-162.4l0-98.1c8.2-.1 16-6.4 16-16V192c0-17.7 14.3-32 32-32s32 14.3 32 32V345.6c0 57.1-30 110-78.9 139.4z"/>
        </svg>
        <span class="applause-count ms-1">{{ applause_count }}</span>
      </button>
    </div>



<!-- === SHARE DROPDOWN === -->
<div class="dropdown share-dropdown-card text-end mt-3 me-3">
  <a class="text-dark-green text-decoration-none fw-semibold" href="#" id="shareDropdown"
     data-bs-toggle="dropdown" aria-expanded="false">
    <i class="bi bi-share me-1"></i> Condividi
  </a>
  <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="shareDropdown">
    <li>
      <a class="dropdown-item" href="https://www.facebook.com/sharer/sharer.php?u={{ request.url|urlencode }}"
         target="_blank" rel="noopener">
        <i class="bi bi-facebook me-2" style="color:#1877F2;"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="https://twitter.com/intent/tweet?url={{ request.url|urlencode }}&text={{ post.title|urlencode }}"
         target="_blank" rel="noopener">
        <i class="bi bi-twitter-x me-2" style="color:#000000;"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url|urlencode }}"
         target="_blank" rel="noopener">
        <i class="bi bi-linkedin me-2" style="color:#0A66C2;"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="https://api.whatsapp.com/send?text={{ post.title|urlencode }}%20{{ request.url|urlencode }}"
         target="_blank" rel="noopener">
        <i class="bi bi-whatsapp me-2" style="color:#25D366;"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item" href="https://t.me/share/url?url={{ request.url|urlencode }}&text={{ post.title|urlencode }}"
         target="_blank" rel="noopener">
        <i class="bi bi-telegram me-2" style="color:#0088cc;"></i>
      </a>
    </li>
    <li>
      <button class="dropdown-item text-danger" type="button" onclick="copyLink()">
        <i class="bi bi-instagram me-2" style="color:#E4405F;"></i>
      </button>
    </li>
  </ul>
</div>



  </article>

  <!-- Toast feedback copia link -->
<div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index:1080">
  <div id="copyToast" class="toast align-items-center text-bg-dark border-0" role="status"
       aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
    <div class="d-flex">
      <div class="toast-body">
        ✅ Link copiato! Incollalo su Instagram Stories o in un post.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast" aria-label="Chiudi"></button>
    </div>
  </div>
</div>


</div>


{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/applause.js') }}"></script>

<script>
  function copyLink() {
    const url = window.location.href;
    const toastEl = document.getElementById('copyToast');
    const toast = bootstrap.Toast.getOrCreateInstance(toastEl);

    if (navigator.clipboard) {
      navigator.clipboard.writeText(url).then(() => {
        toast.show();
      }).catch(() => {
        fallbackCopy(url, toast);
      });
    } else {
      fallbackCopy(url, toast);
    }
  }

  function fallbackCopy(text, toastInst) {
    const input = document.createElement("input");
    input.value = text;
    document.body.appendChild(input);
    input.select();
    document.execCommand("copy");
    document.body.removeChild(input);
    toastInst.show();
  }
</script>

{% endblock %}
