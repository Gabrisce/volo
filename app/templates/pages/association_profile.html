{% extends 'layout/base.html' %}
{% block title %}{{ association.name }}{% endblock %}
{% block container_class %}container-xxl{% endblock %}

{% block content %}
<div>

  <!-- üë§ Header profilo -->
  <div class="row align-items-start mb-4 gy-3">

    <!-- Logo -->
    <div class="col-lg-2 text-center">
      <img
        src="{% if association.photo_filename %}
               {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ association.photo_filename) }}
             {% else %}
               {{ url_for('static', filename='img/avatar-placeholder.png') }}
             {% endif %}"
        class="profile-photo ring-click"
        alt="Logo {{ association.name }}"
        onclick="toggleFullscreen(this)">
    </div>

    <!-- Dati + chip follower + chat -->
    <div class="col-lg-7">
      <div class="d-flex align-items-start justify-content-between">
        <div class="pe-2">
          <h2 class="mb-1">{{ association.name }}</h2>

          {% if association.fiscal_code %}
            <p class="mb-1 text-body-secondary"><strong>C.F./P.IVA:</strong> {{ association.fiscal_code }}</p>
          {% endif %}

          {% if association.bio %}
            <p class="mb-2 text-body-secondary">{{ association.bio }}</p>
          {% endif %}

          {# Follower chip #}
          {% set followers_count = association.followers.count() if association.followers is defined else 0 %}
          <div class="d-flex flex-wrap gap-2 mt-1">
            <a href="{{ url_for('public.public_profile', association_id=association.id) }}#followers"
               class="chip-link text-decoration-none"
               aria-label="{{ _('Vedi follower') }}">
              üë• {{ followers_count }} {{ _('Follower') }}
            </a>

            {# Chat come icona (solo se l‚Äôutente non √® l‚Äôassociazione) #}
            {% if current_user.is_authenticated and current_user.id != association.id %}
              <a href="#"
                id="start-chat-link"
                data-user-id="{{ association.id }}"
                data-user-name="{{ association.name }}"
                data-user-photo="{% if association.photo_filename %}
                                    {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ association.photo_filename) }}
                                  {% else %}
                                    {{ url_for('static', filename='img/default-profile.png') }}
                                  {% endif %}"
                class="d-inline-flex align-items-center text-decoration-none">
                <img src="{{ url_for('static', filename='img/icon_chat.png') }}"
                    alt="Chat" width="30" height="30" class="me-1" />
                </a>
            {% endif %}
          </div>
        </div>

        {# Segui / Smetti di seguire (solo volontari) #}
        {% if current_user.is_authenticated and current_user.user_type == 'volunteer' %}
          <form action="{{ url_for('associations.follow_association', association_id=association.id) }}"
                method="POST" class="d-inline">
            {% if csrf_token is defined %}
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}
            {% if association in current_user.followed_associations %}
              <button type="submit"
                      formaction="{{ url_for('associations.unfollow_association', association_id=association.id) }}"
                      class="btn btn-outline-danger rounded-pill">
                ‚ùå {{ _('Smetti di seguire') }}
              </button>
            {% else %}
              <button type="submit" class="btn btn-outline-success rounded-pill">
                ‚ûï {{ _('Segui') }}
              </button>
            {% endif %}
          </form>
        {% endif %}
      </div>
    </div>

    <!-- Spazio a destra (vuoto nel profilo pubblico) -->
    <div class="col-lg-3 text-lg-end text-center"></div>
  </div>

  <hr class="soft-divider">

  {# ====== LAYOUT A TRE COLONNE: EVENTI | POST | CAMPAGNE ====== #}
  <div class="row g-4">

    {# üìÖ Colonna sinistra: Eventi #}
    <div class="col-xl-3 col-lg-4">
      <section class="card shadow-sm panel-sticky">
        <div class="panel-header">
          <h6 class="mb-0">{{ _('Eventi') }}</h6>
        </div>
        <div class="card-body">
          <!-- Perenni -->
          <div class="scroll-box mb-3">
            <h6 class="sticky-title text-success">{{ _('Perenni') }}</h6>
            {% set has_perennial = false %}
            {% for e in events %}
              {% if (not e.end_date) or (e.duration and e.duration|lower in ['perennial','ongoing','perenne']) %}
                {% set has_perennial = true %}
                <div class="list-item">
                  <a href="{{ url_for('associations.detail', content_type='event', item_id=e.id) }}"
                     class="item-title text-decoration-none">
                    {{ e.title }}
                  </a>
                  <div class="small text-muted">
                    {{ e.location or _('Luogo non specificato') }} ¬∑ {{ _('permanente') }}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
            {% if not has_perennial %}
              <p class="text-muted small mb-0">{{ _('Nessun evento perenne.') }}</p>
            {% endif %}
          </div>

          <!-- Temporanei -->
          <div class="scroll-box">
            <h6 class="sticky-title text-secondary">{{ _('Temporanei') }}</h6>
            {% set has_temporary = false %}
            {% for e in events %}
              {% set is_perennial = (not e.end_date) or (e.duration and e.duration|lower in ['perennial','ongoing','perenne']) %}
              {% if not is_perennial %}
                {% set has_temporary = true %}
                <div class="list-item">
                  <a href="{{ url_for('associations.detail', content_type='event', item_id=e.id) }}"
                     class="item-title text-decoration-none">
                    {{ e.title }}
                  </a>
                  <div class="small text-muted">
                    {% if e.date %}{{ e.date.strftime('%d/%m/%Y') }}{% endif %}
                    {% if e.end_date %}‚Äì{{ e.end_date.strftime('%d/%m/%Y') }}{% endif %}
                    ¬∑ {{ e.location or _('Luogo non specificato') }}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
            {% if not has_temporary %}
              <p class="text-muted small mb-0">{{ _('Nessun evento temporaneo.') }}</p>
            {% endif %}
          </div>
        </div>
      </section>
    </div>

    {# üì∞ Colonna centrale: Post (solo lettura + applausi) #}
    <div class="col-xl-6 col-lg-4">
      <section class="card shadow-sm">
        <div class="panel-header d-flex align-items-center justify-content-between">
          <h6 class="mb-0">{{ _('Post') }}</h6>
        </div>

        <div class="card-body">
          <div class="feed-container" style="max-height: 70vh; overflow-y: auto;">
            {% if posts %}
              {% for post in posts %}
                {% set pid = 'post-' ~ post.id %}
                <article class="card mb-3 shadow-sm post-card">
                  <div class="card-body position-relative">

                    <!-- Titolo & meta -->
                    <h5 class="card-title pe-5">
                      <a href="{{ url_for('posts.post_detail', post_id=post.id) }}"
                         class="text-decoration-none text-dark">
                        {{ post.title or _('Titolo mancante') }}
                      </a>
                    </h5>
                    <p class="text-muted mb-2">
                      {{ _('Pubblicato il') }} {{ post.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </p>

                    <!-- Contenuto collassabile -->
                    <div id="{{ pid }}-content" class="post-body" data-collapsed="true" aria-expanded="false">
                      {{ post.content }}
                      {% if post.image_filename %}
                        <img src="{{ url_for('posts.static', filename='uploads/posts/' ~ post.image_filename) }}"
                             class="img-fluid mt-2 rounded" alt="Immagine post">
                      {% endif %}
                    </div>

                    <!-- Toggle -->
                    <div>
                      <button class="post-toggle-link" type="button"
                              aria-controls="{{ pid }}-content" aria-expanded="false"
                              data-target="#{{ pid }}-content">
                        {{ _('Mostra altro') }}
                      </button>
                    </div>

                    <!-- Applausi -->
                    {% set applause_count = post.applause|length if post.applause is defined else 0 %}
                    {% set user_has_applauded = current_user.is_authenticated and post.applause|selectattr("user_id","equalto",current_user.id)|list|length > 0 %}
                    <div class="mt-2 d-flex align-items-center">
                      <button type="button"
                              class="applause-btn d-inline-flex align-items-center {% if user_has_applauded %}active{% endif %}"
                              data-post-id="{{ post.id }}"
                              aria-label="{{ _('Applaudi il post') }}">
                         <svg class="applause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                        <path d="M368 16V80c0 8.8-7.2 16-16 16s-16-7.2-16-16V16c0-8.8 7.2-16 16-16s16 7.2 16 16zm-98.7 7.1l32 48c4.9 7.4 2.9 17.3-4.4 22.2s-17.3 2.9-22.2-4.4l-32-48c-4.9-7.4-2.9-17.3 4.4-22.2s17.3-2.9 22.2 4.4zM167 119c9.4-9.4 24.6-9.4 33.9 0L324.7 242.7c10.1 10.1 27.3 2.9 27.3-11.3V192c0-17.7 14.3-32 32-32s32 14.3 32 32V345.6c0 57.1-30 110-78.9 139.4c-64 38.4-145.8 28.3-198.5-24.4L39 361c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l53 53c6.1 6.1 16 6.1 22.1 0s6.1-16 0-22.1L55 265c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l93 93c6.1 6.1 16 6.1 22.1 0s6.1-16 0-22.1L87 185c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l117 117c6.1 6.1 16 6.1 22.1 0s6.1-16 0-22.1l-93-93c-9.4-9.4-9.4-24.6 0-33.9zM465.1 484.9c-24.2 14.5-50.9 22.1-77.7 23.1c48.1-39.6 76.6-99 76.6-162.4l0-98.1c8.2-.1 16-6.4 16-16V192c0-17.7 14.3-32 32-32s32 14.3 32 32V345.6c0 57.1-30 110-78.9 139.4zM456.9 18.7c7.4 4.9 9.3 14.8 4.4 22.2l-32 48c-4.9 7.4-14.8 9.3-22.2 4.4s-9.3-14.8-4.4-22.2l32-48c4.9-7.4 14.8-9.3 22.2-4.4z"/>
                      </svg>
                        <span class="applause-count ms-1">{{ applause_count }}</span>
                      </button>
                    </div>

                  </div>
                </article>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">{{ _('Nessun post ancora pubblicato.') }}</p>
            {% endif %}
          </div>
        </div>
      </section>
    </div>

    {# üéÅ Colonna destra: Campagne #}
    <div class="col-xl-3 col-lg-4">
      <section class="card shadow-sm panel-sticky">
        <div class="panel-header">
          <h6 class="mb-0">{{ _('Campagne') }}</h6>
        </div>
        <div class="card-body">

          <!-- Perenni -->
          <div class="scroll-box mb-3">
            <h6 class="sticky-title text-success">{{ _('Perenni') }}</h6>
            {% set has_c_perennial = false %}
            {% for c in campaigns %}
              {% if (not c.end_date) or (c.duration and c.duration|lower in ['perennial','ongoing','perenne']) %}
                {% set has_c_perennial = true %}
                <div class="list-item">
                  <a href="{{ url_for('associations.detail', content_type='campaign', item_id=c.id) }}"
                     class="item-title text-decoration-none">
                    {{ c.title }}
                  </a>
                  <div class="small text-muted">
                    {{ c.goal or _('Obiettivo non indicato') }} ¬∑ {{ _('permanente') }}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
            {% if not has_c_perennial %}
              <p class="text-muted small mb-0">{{ _('Nessuna campagna perenne.') }}</p>
            {% endif %}
          </div>

          <!-- Temporanee -->
          <div class="scroll-box">
            <h6 class="sticky-title text-secondary">{{ _('Temporanee') }}</h6>
            {% set has_c_temporary = false %}
            {% for c in campaigns %}
              {% set is_perennial = (not c.end_date) or (c.duration and c.duration|lower in ['perennial','ongoing','perenne']) %}
              {% if not is_perennial %}
                {% set has_c_temporary = true %}
                <div class="list-item">
                  <a href="{{ url_for('associations.detail', content_type='campaign', item_id=c.id) }}"
                     class="item-title text-decoration-none">
                    {{ c.title }}
                  </a>
                  <div class="small text-muted">
                    {% if c.date %}{{ c.date.strftime('%d/%m/%Y') }}{% endif %}
                    {% if c.end_date %}‚Äì{{ c.end_date.strftime('%d/%m/%Y') }}{% endif %}
                    {% if c.goal %} ¬∑ {{ c.goal }}{% endif %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
            {% if not has_c_temporary %}
              <p class="text-muted small mb-0">{{ _('Nessuna campagna temporanea.') }}</p>
            {% endif %}
          </div>

        </div>
      </section>
    </div>

  </div>

  <hr class="soft-divider">

</div>

{% endblock %}

{% block scripts %}
<script>
  // Toggle "Mostra altro / meno" per i post
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.post-toggle-link').forEach(btn => {
      const targetSel = btn.getAttribute('data-target');
      const target = document.querySelector(targetSel);
      if (!target) return;

      const needsToggle = target.scrollHeight > target.clientHeight + 6;
      if (!needsToggle) {
        btn.style.display = 'none';
        target.setAttribute('data-collapsed', 'false');
        target.setAttribute('aria-expanded', 'true');
        return;
      }

      btn.addEventListener('click', () => {
        const isCollapsed = target.getAttribute('data-collapsed') !== 'false';
        target.setAttribute('data-collapsed', String(!isCollapsed));
        target.setAttribute('aria-expanded', String(isCollapsed));
        btn.setAttribute('aria-expanded', String(isCollapsed));
        btn.textContent = isCollapsed ? '{{ _("Mostra meno") }}' : '{{ _("Mostra altro") }}';
      });
    });
  });

  // Zoom logo
  function toggleFullscreen(img) {
    let existing = document.getElementById("img-overlay");
    if (existing) { existing.remove(); return; }

    let overlay = document.createElement("div");
    overlay.id = "img-overlay";
    Object.assign(overlay.style, {
      position: "fixed", inset: 0, background: "rgba(0,0,0,.8)",
      display: "flex", alignItems: "center", justifyContent: "center",
      zIndex: 9999, cursor: "zoom-out"
    });

    let bigImg = document.createElement("img");
    Object.assign(bigImg.style, {
      maxWidth: "90%", maxHeight: "90%", borderRadius: "10px",
      boxShadow: "0 4px 20px rgba(0,0,0,.5)"
    });
    bigImg.src = img.src;

    overlay.appendChild(bigImg);
    overlay.addEventListener("click", () => overlay.remove());
    document.body.appendChild(overlay);
  }

  // Avvio chat (profilo pubblico)
  document.addEventListener("DOMContentLoaded", () => {
  const chatLink = document.getElementById("start-chat-link");
  if (!chatLink) return;

  chatLink.addEventListener("click", async (e) => {
    e.preventDefault();

    const otherId = chatLink.dataset.userId;
    const otherName = chatLink.dataset.userName;
    const otherPhoto = chatLink.dataset.userPhoto;

    try {
      const res = await fetch(`/public/api/start_chat/${otherId}`, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await res.json();

      if (data.success) {
        if (typeof openChatWindow === "function") {
          openChatWindow(otherId, otherName, otherPhoto);
        }
        if (typeof loadContacts === "function") {
          loadContacts();
        }
      } else {
        console.error(data.error || "Errore nell'avvio della chat.");
      }
    } catch (err) {
      console.error("Errore nell'avvio della chat:", err);
    }
  });
});
</script>



<!-- Script applausi esterno -->
<script src="{{ url_for('static', filename='js/applause.js') }}"></script>
{% endblock %}
