{% extends 'layout/base.html' %}

{% block title %}Dashboard Volontario{% endblock %}
{% block container_class %}container-xxl{% endblock %}

{% block content %}

<!-- ====== HEADER PROFILO ====== -->
<div class="row align-items-center mb-4 gy-3">
  <!-- Foto profilo -->
  <div class="col-md-2 text-center">
    {% if current_user.photo_filename and current_user.photo_filename|length > 0 %}
      <img src="{{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ current_user.photo_filename) }}"
           class="profile-photo ring-click"
           alt="Foto profilo"
           onclick="toggleFullscreen(this)">
    {% else %}
      <img src="{{ url_for('static', filename='img/avatar-placeholder.png') }}"
           class="profile-photo ring-click"
           alt="Foto profilo"
           onclick="toggleFullscreen(this)">
    {% endif %}
  </div>

  <!-- Dati anagrafici -->
  <div class="col-md-7">
    <div class="d-flex align-items-start justify-content-between">
      <div>
        <h3 class="mb-1">{{ current_user.name }}</h3>
        <p class="mb-2">
          <a href="{{ url_for('public.followed_associations') }}" class="chip-link">
            üë• {{ current_user.followed_associations.count() }} {{ _('seguite') }}
          </a>
        </p>
        {% if current_user.bio %}
          <p class="mb-0 text-body-secondary">{{ current_user.bio }}</p>
        {% endif %}
      </div>

      <a href="{{ url_for('settings.edit_profile') }}"
         class="icon-btn ghost"
         title="{{ _('Modifica profilo') }}"
         aria-label="{{ _('Modifica profilo') }}">
        <i class="bi bi-gear-fill"></i>
      </a>
    </div>
  </div>

  <!-- Pulsanti in alto a destra -->
  <div class="col-md-3 text-md-end text-center">
    <a href="{{ url_for('reports.create_report') }}" class="btn btn-ghost-warning me-2">
      <i class="bi bi-geo-alt-fill me-1"></i>{{ _('Segnala!') }}
    </a>
    <a href="{{ url_for('petitions.create_petition') }}" class="btn btn-primary">
      <i class="bi bi-pencil-square me-1"></i>{{ _('Nuova Petizione') }}
    </a>
  </div>
</div>

<hr class="soft-divider">

<!-- ====== LAYOUT A TRE COLONNE ====== -->
<div class="row g-4">

  <!-- SINISTRA: Storico attivit√† -->
  <div class="col-lg-3">
    <section aria-labelledby="history-title" class="card shadow-sm panel-sticky">
      <div class="panel-header">
        <h2 id="history-title" class="h6 mb-0">{{ _('Storico attivit√†') }}</h2>
      </div>
      <div class="card-body">
        <div class="scroll-area">
          <ul class="list-unstyled m-0">
            {% if donations and donations|length > 0 %}
              {% for d in donations %}
                <li class="list-item">
                  <div class="list-grid">
                    <div class="min-w-0">
                      <a href="{{ url_for('campaigns.campaign_detail', campaign_id=d.campaign.id) }}"
                         class="item-title link-strong">
                        {{ d.campaign.title }}
                      </a>
                      <span class="badge-soft success">{{ _('Campagna') }}</span>
                      <div class="small text-muted mt-1">
                        {{ d.created_at.strftime('%d/%m/%Y') }}
                        {% if d.amount %} ‚Äî {{ '%.2f'|format(d.amount) }} ‚Ç¨ {% endif %}
                      </div>
                    </div>

                    <div class="text-end">
                      {% if d.pdf_filename %}
                        <a href="{{ url_for('payments.download_receipt', filename=d.pdf_filename) }}"
                           target="_blank" rel="noopener noreferrer"
                           class="icon-btn ghost" aria-label="Apri ricevuta PDF" title="Apri ricevuta PDF">
                          <i class="bi bi-filetype-pdf text-danger"></i>
                        </a>
                      {% else %}
                        <span class="small text-muted d-inline-block mt-1">{{ _('PDF non disponibile') }}</span>
                      {% endif %}
                    </div>
                  </div>
                </li>
              {% endfor %}
            {% else %}
              <li class="text-muted py-2">{{ _('Nessuna campagna nello storico.') }}</li>
            {% endif %}
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- CENTRO: Segnalazioni e Petizioni -->
  <div class="col-lg-6">
    {% if activities %}
      <div class="feed-container" style="max-height: 520px; overflow-y: auto; padding-right: 6px;">
        {% for item in activities %}
          <article class="card shadow-sm mb-3 feed-card">
            <div class="card-body position-relative">

              <!-- Azioni (cestino) -->
              <div class="report-actions" aria-label="Azioni contenuto">
                {% if item.type == 'report' %}
                  <button type="button" class="icon-btn danger"
                          title="{{ _('Elimina') }}"
                          data-bs-toggle="modal" data-bs-target="#confirmDeleteModal-report-{{ item.id }}">
                    <i class="bi bi-trash"></i>
                  </button>
                {% elif item.type == 'petition' %}
                  <button type="button" class="icon-btn danger"
                          title="{{ _('Elimina') }}"
                          data-bs-toggle="modal" data-bs-target="#confirmDeleteModal-petition-{{ item.id }}">
                    <i class="bi bi-trash"></i>
                  </button>
                {% endif %}
              </div>

              <!-- Modale conferma eliminazione -->
              {% if item.type == 'report' %}
                <div class="modal fade" id="confirmDeleteModal-report-{{ item.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">{{ _('Conferma eliminazione') }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        {{ _('Sei sicuro di voler eliminare la segnalazione') }} <strong>{{ item.title }}</strong>?
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">{{ _('Annulla') }}</button>
                        <form action="{{ url_for('reports.delete_report', report_id=item.id) }}" method="POST">
                          <button type="submit" class="btn btn-danger btn-sm">{{ _('Elimina') }}</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% elif item.type == 'petition' %}
                <div class="modal fade" id="confirmDeleteModal-petition-{{ item.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">{{ _('Conferma eliminazione') }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        {{ _('Sei sicuro di voler eliminare la petizione') }} <strong>{{ item.title }}</strong>?
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">{{ _('Annulla') }}</button>
                        <form action="{{ url_for('petitions.delete_petition', petition_id=item.id) }}" method="POST">
                          <button type="submit" class="btn btn-danger btn-sm">{{ _('Elimina') }}</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}

              <!-- Contenuto -->
              <h5 class="card-title mb-1">
                {% if item.type == 'report' %}
                  <a href="{{ url_for('public.detail', content_type='report', item_id=item.id) }}"
                     class="text-decoration-none text-dark">{{ item.title }}</a>
                {% elif item.type == 'petition' %}
                  <a href="{{ url_for('petitions.petition_detail', petition_id=item.id) }}"
                     class="text-decoration-none text-dark">{{ item.title }}</a>
                {% endif %}
              </h5>

              <small class="text-muted d-block mb-2">
                üóìÔ∏è {{ item.created_at.strftime("%d/%m/%Y %H:%M") }}
                {% if item.type == 'report' %}
                  ¬∑ üìç {{ item.address if item.address else (item.latitude ~ ", " ~ item.longitude) }}
                {% endif %}
              </small>

              {% if item.description %}
                <p class="card-text clamp" data-clamp="4">{{ item.description }}</p>
              {% endif %}

              {% if item.image_filename %}
                <div class="media-wrap clamp-media mb-2">
                  {% if item.type == 'report' %}
                    <img src="{{ url_for('reports.static', filename='uploads/reports/' ~ item.image_filename) }}"
                         class="img-fluid rounded" alt="Immagine segnalazione">
                  {% elif item.type == 'petition' %}
                    <img src="{{ url_for('petitions.static', filename='uploads/petitions/' ~ item.image_filename) }}"
                         class="img-fluid rounded" alt="Immagine petizione">
                  {% endif %}
                </div>
              {% endif %}

              <button type="button" class="toggle-card d-none">{{ _('Mostra altro') }}</button>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light mb-0">{{ _('Non hai ancora effettuato segnalazioni o petizioni.') }}</div>
    {% endif %}
  </div>

  <!-- DESTRA: Prossimi eventi -->
  <div class="col-lg-3">
    <section aria-labelledby="upcoming-title" class="card shadow-sm panel-sticky">
      <div class="panel-header">
        <h2 id="upcoming-title" class="h6 mb-0">{{ _('Prossimi eventi') }}</h2>
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0">
          {% if participations %}
            {% for p in participations %}
              <li class="list-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="min-w-0">
                    <a href="{{ url_for('events.event_detail', event_id=p.event.id) }}" class="item-title">
                      {{ p.event.title }}
                    </a>
                    <div class="small text-muted">
                      üìÖ {{ p.event.date.strftime("%d/%m/%Y %H:%M") }}
                      {% if p.event.location %} ¬∑ üìç {{ p.event.location }}{% endif %}
                    </div>
                  </div>
                  <div class="status-dot" data-status="{{ p.status }}"></div>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="text-muted py-2">{{ _('Nessun evento futuro a cui partecipi.') }}</li>
          {% endif %}
        </ul>
      </div>
    </section>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  // Clamp/expand come nella home
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.feed-card').forEach(function(card){
      const text = card.querySelector('.clamp');
      const media = card.querySelector('.clamp-media');
      const btn   = card.querySelector('.toggle-card');

      let needsToggle = false;
      if (text && (text.innerText || '').trim().length > 300) needsToggle = true;
      if (media) needsToggle = true;

      if (needsToggle && btn) {
        btn.classList.remove('d-none');
        btn.addEventListener('click', function(){
          card.classList.toggle('expanded');
          btn.textContent = card.classList.contains('expanded') ? 'Mostra meno' : 'Mostra altro';
        });
      }
    });
  });

  // Fullscreen foto profilo
  function toggleFullscreen(img) {
    let existing = document.getElementById("img-overlay");
    if (existing) { existing.remove(); return; }

    let overlay = document.createElement("div");
    overlay.id = "img-overlay";
    Object.assign(overlay.style, {
      position: "fixed", inset: 0, background: "rgba(0,0,0,.8)",
      display: "flex", alignItems: "center", justifyContent: "center",
      zIndex: 9999, cursor: "zoom-out"
    });

    let bigImg = document.createElement("img");
    Object.assign(bigImg.style, {
      maxWidth: "90%", maxHeight: "90%", borderRadius: "10px",
      boxShadow: "0 4px 20px rgba(0,0,0,.5)"
    });
    bigImg.src = img.src;

    overlay.appendChild(bigImg);
    overlay.addEventListener("click", () => overlay.remove());
    document.body.appendChild(overlay);
  }
</script>

<style>
  /* ===== Base / utility ===== */
  .soft-divider { border: 0; border-top: 1px solid #eef2f7; margin: .75rem 0 1rem; }
  .card { border-radius: 12px; }

  /* Foto profilo con ring */
  .profile-photo{
    width:150px; height:150px; object-fit:cover;
    border-radius:50%;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
    border: 4px solid #fff;
    outline: 2px solid rgba(1,159,149,.25); /* ring brand */
  }
  .ring-click{ cursor: pointer; }

  /* Chip link (associazioni seguite) */
  .chip-link{
    display:inline-block;
    background:#f7f9fb;
    border:1px solid #dfe6ee;
    color:#2b3a42; text-decoration:none;
    border-radius:999px; padding:.28rem .6rem; font-weight:600;
  }
  .chip-link:hover{ background:#f2f6fb; }

  /* Bottoni azione header */
  .btn-ghost-warning{
    --bs-btn-color:#b58100;
    --bs-btn-bg:#fff;
    --bs-btn-border-color:#f9e3a6;
    --bs-btn-hover-bg:#fff8e6;
    --bs-btn-hover-border-color:#f1d684;
    --bs-btn-padding-y:.5rem; --bs-btn-padding-x:.8rem; --bs-btn-border-radius:.7rem;
    border:1px solid var(--bs-btn-border-color);
  }
  .btn-primary{ border-radius:.7rem; }

  /* Icon button */
  .icon-btn{
    width: 36px; height: 36px;
    display:inline-flex; align-items:center; justify-content:center;
    border:none; background:transparent; color:#6b7280;
    border-radius:10px; transition:background .15s ease, color .15s ease;
    padding:0;
  }
  .icon-btn.ghost{ border:1px solid #e6eaf0; background:#fff; }
  .icon-btn:hover{ background:rgba(0,0,0,.05); color:#0d6efd; }
  .icon-btn.danger:hover{ color:#dc3545; }
  .icon-btn i{ font-size:1.05rem; }

  /* Pannelli laterali coerenti (sticky + header chiaro) */
  .panel-sticky{ position: sticky; top: 84px; overflow: hidden; }
  @media (min-width: 1400px){ .panel-sticky{ top: 92px; } }

  .panel-header{
    padding:.75rem 1rem;
    background: linear-gradient(180deg, #ffffff, #f8fafc);
    border-bottom: 1px solid #eef2f7;
  }

  .scroll-area{ max-height: 320px; overflow-y: auto; padding-right: 6px; }

  /* List item neutri */
  .list-item{
    padding:.55rem .35rem;
    border-bottom:1px dashed #edf1f6;
  }
  .list-item:last-child{ border-bottom:0; }

  .list-grid{ display:grid; grid-template-columns: 1fr auto; gap:.5rem; align-items:start; }

  .item-title{
    color:#0f172a; font-weight:600; text-decoration:none;
  }
  .item-title:hover{ text-decoration:underline; text-underline-offset:2px; }

  /* Badge soft */
  .badge-soft{
    display:inline-block; font-weight:600; font-size:.72rem;
    padding:.15rem .4rem; border-radius:.5rem; border:1px solid transparent;
  }
  .badge-soft.success{ background:#ecfdf5; color:#05603a; border-color:#a7f3d0; }

  /* Feed (clamp) come home */
  .feed-card .card-body{ padding:.9rem 1rem; }
  .feed-card:not(.expanded) .clamp{
    display:-webkit-box; -webkit-box-orient:vertical; overflow:hidden;
    line-clamp:3; -webkit-line-clamp:3;
  }
  @supports not (-webkit-line-clamp: 1){
    .feed-card:not(.expanded) .clamp{ max-height:4.8em; overflow:hidden; }
  }
  .feed-card:not(.expanded) .clamp-media{ max-height:10px; overflow:hidden; }
  .feed-card.expanded .clamp{ line-clamp:initial; -webkit-line-clamp:initial; max-height:none; }
  .feed-card.expanded .clamp-media{ max-height:none; }

  .toggle-card{
    color:#006400; font-size:.85rem; margin-top:.25rem;
    background:none; border:none; padding:0; cursor:pointer; text-decoration:underline;
  }
  .toggle-card:hover{ color:#004d00; }

  /* Icone azioni card */
  .report-actions{
    position:absolute; top:.6rem; right:.6rem; display:flex; gap:.35rem;
  }

  /* Stato partecipazione (dot) */
  .status-dot{
    width:12px; height:12px; border-radius:50%; margin-top:.25rem;
    border:1px solid #e6eaf0;
  }
  .status-dot[data-status="accepted"]{ background:#16a34a; }  /* verde */
  .status-dot[data-status="rejected"]{ background:#dc2626; }  /* rosso  */
  .status-dot[data-status="pending"]{  background:#f59e0b; }  /* giallo */

</style>
{% endblock %}
