{% extends 'layout/base.html' %}

{% block title %}Profilo Volontario{% endblock %}
{% block container_class %}container-xxl{% endblock %}

{% block content %}

<!-- ===== HERO PROFILO PUBBLICO ===== -->
<section class="text-center mb-4">
  <div class="d-inline-flex align-items-center justify-content-center position-relative">
    <img
      src="{% if volunteer.photo_filename %}
              {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ volunteer.photo_filename) }}
            {% else %}
              {{ url_for('static', filename='img/default-profile.png') }}
            {% endif %}"
      class="profile-photo ring-click"
      alt="Foto profilo {{ volunteer.name }}"
      onclick="toggleFullscreen(this)">

  </div>

  <h2 class="fw-bold mt-2 mb-1">{{ volunteer.name }}</h2>

  {% if volunteer.bio %}
    <p class="text-body-secondary mb-2" style="max-width:720px;margin:0 auto;">{{ volunteer.bio }}</p>
  {% endif %}

  <div class="d-flex flex-column align-items-center mt-2">

  <!-- üë• Follower -->
  <a href="{{ url_for('public.volunteer_followed_associations', volunteer_id=volunteer.id) }}"
     class="text-decoration-none fw-bold text-muted mb-2">
    üë• {{ followed_associations_count }}
    {% if followed_associations_count == 1 %}
      {{ _('Follower') }}
    {% else %}
      {{ _('Follower') }}
    {% endif %}
  </a>

  <!-- üí¨ Chat -->
  {% if current_user.is_authenticated and current_user.id != volunteer.id %}
    <a href="#"
       id="start-chat-link"
       data-user-id="{{ volunteer.id }}"
       data-user-name="{{ volunteer.name }}"
       data-user-photo="{% if volunteer.photo_filename %}
                           {{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ volunteer.photo_filename) }}
                         {% else %}
                           {{ url_for('static', filename='img/default-profile.png') }}
                         {% endif %}"
       class="d-inline-flex align-items-center text-decoration-none">
      <img src="{{ url_for('static', filename='img/icon_chat.png') }}"
           alt="Chat" width="30" height="30" class="me-1" />
    </a>
  {% endif %}
</div>

</section>

<hr class="soft-divider">

<!-- ===== LAYOUT DUE COLONNE ===== -->
<div class="row g-4">

  <!-- CENTRO/SINISTRA: Segnalazioni -->
  <div class="col-lg-7 col-xl-8">
    <section aria-labelledby="reports-title" class="card shadow-sm">
      <div class="panel-header">
        <h2 id="reports-title" class="h6 mb-0">{{ _('Segnalazioni pubbliche') }}</h2>
      </div>

      <div class="card-body">
        <div class="feed-container" style="max-height: 70vh; overflow-y: auto; padding-right:6px;">
          {% if reports %}
            {% for report in reports %}
              <article class="card shadow-sm mb-3 feed-card">
                <div class="card-body position-relative">
                  <h5 class="card-title mb-1">
                    <a href="{{ url_for('public.detail', content_type='report', item_id=report.id) }}"
                       class="text-decoration-none text-dark">{{ report.title or _('Titolo mancante') }}</a>
                  </h5>

                  <small class="text-muted d-block mb-2">
                    {{ _('Pubblicato il') }} {{ report.created_at.strftime('%d/%m/%Y %H:%M') }}
                  </small>

                  {% if report.description %}
                    <p class="card-text clamp" data-clamp="4">{{ report.description }}</p>
                  {% endif %}

                  {% if report.image_filename %}
                    <div class="media-wrap clamp-media mb-2">
                      <img src="{{ url_for('reports.static', filename='uploads/reports/' ~ report.image_filename) }}"
                           class="img-fluid rounded" alt="Immagine segnalazione">
                    </div>
                  {% endif %}

                  <button type="button" class="toggle-card d-none">{{ _('Mostra altro') }}</button>
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="text-muted mb-0">{{ _('Nessuna segnalazione ancora effettuata.') }}</p>
          {% endif %}
        </div>
      </div>
    </section>
  </div>

  <!-- DESTRA: Storico partecipazioni -->
  <div class="col-lg-5 col-xl-4">
    <section aria-labelledby="history-title" class="card shadow-sm panel-sticky">
      <div class="panel-header">
        <h2 id="history-title" class="h6 mb-0">{{ _('Storico attivit√†') }}</h2>
      </div>

      <div class="card-body">
        <ul class="list-unstyled m-0">
          {% if participations and participations|length > 0 %}
            {% for p in participations %}
              <li class="list-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="min-w-0">
                    <a href="{{ url_for('events.event_detail', event_id=p.event.id) }}"
                       class="item-title text-decoration-none">
                      {{ p.event.title }}
                    </a>
                    <div class="small text-muted mt-1">
                      {{ p.event.date.strftime('%d/%m/%Y') }}
                      {% if p.event.location %} ¬∑ üìç {{ p.event.location }}{% endif %}
                    </div>
                  </div>
                  <div class="status-dot"
                       title="{{ p.status }}"
                       data-status="{{ p.status|lower }}"></div>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="text-muted py-2">{{ _('Nessuna partecipazione negli eventi passati.') }}</li>
          {% endif %}
        </ul>
      </div>
    </section>
  </div>

</div>

{% endblock %}

{% block scripts %}
<script>
  // Clamp/expand per descrizioni lunghe (come su Home/Dashboard)
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.feed-card').forEach(function(card){
      const text = card.querySelector('.clamp');
      const media = card.querySelector('.clamp-media');
      const btn   = card.querySelector('.toggle-card');
      let needsToggle = false;

      if (text && (text.innerText || '').trim().length > 300) needsToggle = true;
      if (media) needsToggle = true;

      if (needsToggle && btn) {
        btn.classList.remove('d-none');
        btn.addEventListener('click', function(){
          card.classList.toggle('expanded');
          btn.textContent = card.classList.contains('expanded') ? 'Mostra meno' : 'Mostra altro';
        });
      }
    });
  });

  // Zoom immagine (riuso della logica gi√† vista)
  function toggleFullscreen(img) {
    let existing = document.getElementById("img-overlay");
    if (existing) { existing.remove(); return; }
    let overlay = document.createElement("div");
    overlay.id = "img-overlay";
    Object.assign(overlay.style, {
      position: "fixed", inset: 0, background: "rgba(0,0,0,.8)",
      display: "flex", alignItems: "center", justifyContent: "center",
      zIndex: 9999, cursor: "zoom-out"
    });
    let bigImg = document.createElement("img");
    Object.assign(bigImg.style, {
      maxWidth: "90%", maxHeight: "90%", borderRadius: "10px",
      boxShadow: "0 4px 20px rgba(0,0,0,.5)"
    });
    bigImg.src = img.src;
    overlay.appendChild(bigImg);
    overlay.addEventListener("click", () => overlay.remove());
    document.body.appendChild(overlay);
  }
</script>

{% endblock %}
