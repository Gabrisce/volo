{% extends 'layout/base.html' %}
{% block title %}I miei eventi{% endblock %}

{% block content %}
<div class="container-xxl">

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h2 class="mb-0">{{ _('I miei eventi') }}</h2>
    <a href="{{ url_for('events.create_event') }}" class="btn-ghost-brand btn-ghost-sm rounded-pill">
      <i class="bi bi-plus-lg me-1"></i>{{ _('Crea nuovo evento') }}
    </a>
  </div>

  {# -- riferimento all'orario corrente passato dalla route -- #}
  {% set now = namespace(value=current_time) %}

  {# ==================== EVENTI ATTIVI ==================== #}
  <div class="mb-3">
    <h5 class="mb-2 d-flex align-items-center gap-2">
      <i class="bi bi-lightning-charge"></i> {{ _('Eventi attivi') }}
    </h5>

    {% set active = namespace(found=False) %}
    <div class="row g-3">
      {% for event in events %}
        {# end_dt = end_date (se esiste), altrimenti fine giornata della start date #}
        {% set end_dt = event.end_date
                        | default(event.date.replace(hour=23, minute=59, second=59, microsecond=999999), true) %}
        {% set ended = now.value is not none and end_dt < now.value %}
        {% if not ended %}
          {% set active.found = True %}
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              {% if event.image_filename %}
                <img src="{{ url_for('events.static', filename='uploads/events/' ~ event.image_filename) }}"
                     class="card-img-top" alt="Immagine evento" style="object-fit:cover; height:180px;">
              {% else %}
                <div class="d-flex align-items-center justify-content-center bg-light" style="height:180px;">
                  <span class="text-muted">{{ _('Nessuna immagine') }}</span>
                </div>
              {% endif %}

              <div class="card-body position-relative d-flex flex-column">
                <div class="post-actions">
                  <a href="{{ url_for('events.edit_event', event_id=event.id) }}"
                     class="icon-btn" title="{{ _('Modifica') }}" aria-label="{{ _('Modifica evento') }}">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <form action="{{ url_for('events.delete_event', event_id=event.id) }}"
                        method="POST" class="icon-btn-form"
                        onsubmit="return confirm('Sei sicuro di voler eliminare questo evento?');">
                    <button type="submit" class="icon-btn danger" title="{{ _('Elimina') }}" aria-label="{{ _('Elimina evento') }}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>

                <h5 class="card-title pe-5 mb-2">
                  <a href="{{ url_for('public.detail', content_type='event', item_id=event.id) }}"
                     class="text-decoration-none text-dark">{{ event.title }}</a>
                </h5>

                <p class="card-text mb-1">
                  <small class="text-muted">
                    {% if event.date %}
                      ğŸ—“ï¸ {{ _('Inizio:') }} {{ event.date.strftime('%d/%m/%Y %H:%M') }}
                      {% if event.end_date is defined and event.end_date %}
                        â€” {{ _('Fine:') }} {{ event.end_date.strftime('%d/%m/%Y %H:%M') }}
                      {% else %}
                        â€” {{ _('Fine:') }} {{ event.date.strftime('%d/%m/%Y') }} 23:59
                      {% endif %}
                      <br>
                    {% endif %}
                    ğŸ“ {{ event.location or _('Luogo non specificato') }}
                  </small>
                </p>

                <div class="mt-auto d-flex justify-content-end align-items-center gap-2">
                  <a href="{{ url_for('events.participants', event_id=event.id) }}"
                     class="text-decoration-none" title="{{ _('Partecipanti') }}" aria-label="{{ _('Vedi partecipanti') }}">
                    ğŸ‘¥ {{ event.participants|length }}
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    {% if not active.found %}
      <div class="alert alert-light mt-2 mb-0">{{ _('Nessun evento attivo.') }}</div>
    {% endif %}
  </div>

  {# ==================== EVENTI PASSATI ==================== #}
  <div class="mt-4">
    <h5 class="mb-2 d-flex align-items-center gap-2">
      <i class="bi bi-clock-history"></i> {{ _('Eventi passati') }}
    </h5>

    {% set past = namespace(found=False) %}
    <div class="row g-3">
      {% for event in events %}
        {% set end_dt = event.end_date
                        | default(event.date.replace(hour=23, minute=59, second=59, microsecond=999999), true) %}
        {% set ended = now.value is not none and end_dt < now.value %}
        {% if ended %}
          {% set past.found = True %}
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              {% if event.image_filename %}
                <img src="{{ url_for('events.static', filename='uploads/events/' ~ event.image_filename) }}"
                     class="card-img-top" alt="Immagine evento" style="object-fit:cover; height:180px;">
              {% else %}
                <div class="d-flex align-items-center justify-content-center bg-light" style="height:180px;">
                  <span class="text-muted">{{ _('Nessuna immagine') }}</span>
                </div>
              {% endif %}

              <div class="card-body position-relative d-flex flex-column">
                <h5 class="card-title mb-2">
                  <a href="{{ url_for('public.detail', content_type='event', item_id=event.id) }}"
                     class="text-decoration-none text-dark">{{ event.title }}</a>
                </h5>

                <p class="card-text mb-1">
                  <small class="text-muted">
                    {% if event.date %}
                      ğŸ—“ï¸ {{ _('Inizio:') }} {{ event.date.strftime('%d/%m/%Y %H:%M') }}
                      {% if event.end_date is defined and event.end_date %}
                        â€” {{ _('Fine:') }} {{ event.end_date.strftime('%d/%m/%Y %H:%M') }}
                      {% else %}
                        â€” {{ _('Fine:') }} {{ event.date.strftime('%d/%m/%Y') }} 23:59
                      {% endif %}
                      <br>
                    {% endif %}
                    ğŸ“ {{ event.location or _('Luogo non specificato') }}
                  </small>
                </p>

                <div class="mt-auto d-flex justify-content-end">
                  <span class="text-muted">ğŸ‘¥ {{ event.participants|length }}</span>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    {% if not past.found %}
      <div class="alert alert-light mt-2 mb-0">{{ _('Non ci sono eventi passati.') }}</div>
    {% endif %}
  </div>

</div>
{% endblock %}
