{% extends 'layout/base.html' %}
{% block title %}{{ _('Impostazioni â€¢ Preferenze') }}{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-0">{{ _('Preferenze') }}</h2>
    <p class="text-muted mb-0">{{ _('Lingua, tema e notifiche.') }}</p>
  </div>
</header>

<form method="POST" novalidate class="needs-validation">
  {{ form.hidden_tag() if form is defined }}

  <div class="row g-4">
    <!-- ðŸ”¹ Colonna Interfaccia -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">{{ _('Interfaccia') }}</h5>

          <!-- Lingua -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center" 
                id="langToggle" 
                style="cursor:pointer;">
              <label class="form-label mb-0">{{ _('Lingua') }}</label>
              <i id="langChevron" class="bi bi-chevron-down"></i>
            </div>

            <div class="mt-2 d-none" id="languageList">
              <div class="list-group">
                <!-- Italiano -->
                <a href="{{ url_for('lang.set_language', lang_code='it') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'it' %}active{% endif %}">
                  <span class="me-2">ðŸ‡®ðŸ‡¹</span>
                  <span class="flex-grow-1">{{ _('Italiano') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'it' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>
                <!-- Inglese -->
                <a href="{{ url_for('lang.set_language', lang_code='en') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'en' %}active{% endif %}">
                  <span class="me-2">ðŸ‡¬ðŸ‡§</span>
                  <span class="flex-grow-1">{{ _('Inglese') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'en' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>

                <!-- Spagnolo -->
                <a href="{{ url_for('lang.set_language', lang_code='es') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'es' %}active{% endif %}">
                  <span class="me-2">ðŸ‡ªðŸ‡¸</span>
                  <span class="flex-grow-1">{{ _('Spagnolo') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'es' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>

                <!-- Francese -->
                <a href="{{ url_for('lang.set_language', lang_code='fr') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'fr' %}active{% endif %}">
                  <span class="me-2">ðŸ‡«ðŸ‡·</span>
                  <span class="flex-grow-1">{{ _('Francese') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'fr' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>

                <!-- Ucraino -->
                <a href="{{ url_for('lang.set_language', lang_code='uk') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'uk' %}active{% endif %}">
                  <span class="me-2">ðŸ‡ºðŸ‡¦</span>
                  <span class="flex-grow-1">{{ _('Ucraino') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'uk' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>

                <!-- Russo -->
                <a href="{{ url_for('lang.set_language', lang_code='ru') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'ru' %}active{% endif %}">
                  <span class="me-2">ðŸ‡·ðŸ‡º</span>
                  <span class="flex-grow-1">{{ _('Russo') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'ru' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>

                <!-- Arabo -->
                <a href="{{ url_for('lang.set_language', lang_code='ar') }}"
                  onclick="event.stopPropagation(); window.location.href=this.href;"
                  class="list-group-item list-group-item-action d-flex align-items-center {% if session.get('lang') == 'ar' %}active{% endif %}">
                  <span class="me-2">ðŸ‡¸ðŸ‡¦</span>
                  <span class="flex-grow-1">{{ _('Arabo') }}</span>
                  <span class="ms-auto">
                    {% if session.get('lang') == 'ar' %}
                      <i class="bi bi-circle-fill"></i>
                    {% else %}
                      <i class="bi bi-circle"></i>
                    {% endif %}
                  </span>
                </a>
      </div>
    </div>
  </div>



          <!-- Tema -->
          <div>
            <label for="theme" class="form-label">{{ _('Tema') }}</label>
            {% if form is defined %}
              {{ form.theme(class="form-select", id="theme") }}
            {% else %}
              <select id="theme" name="theme" class="form-select" aria-label="{{ _('Seleziona tema') }}">
                <option value="system">{{ _('Sistema') }}</option>
                <option value="light">{{ _('Chiaro') }}</option>
                <option value="dark">{{ _('Scuro') }}</option>
              </select>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ Colonna Notifiche -->
    <div class="col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">{{ _('Notifiche') }}</h5>

          <div class="form-check form-switch mb-2">
            {% if form is defined %}
              {{ form.notify_email(class="form-check-input", id="notify_email") }}
            {% else %}
              <input class="form-check-input" type="checkbox" id="notify_email" name="notify_email" checked>
            {% endif %}
            <label class="form-check-label" for="notify_email">{{ _('Email') }}</label>
          </div>

          <div class="form-check form-switch mb-2">
            {% if form is defined %}
              {{ form.notify_push(class="form-check-input", id="notify_push") }}
            {% else %}
              <input class="form-check-input" type="checkbox" id="notify_push" name="notify_push">
            {% endif %}
            <label class="form-check-label" for="notify_push">{{ _('Push (browser/app)') }}</label>
          </div>

          <div class="form-check form-switch">
            {% if form is defined %}
              {{ form.notify_news(class="form-check-input", id="notify_news") }}
            {% else %}
              <input class="form-check-input" type="checkbox" id="notify_news" name="notify_news">
            {% endif %}
            <label class="form-check-label" for="notify_news">{{ _('Aggiornamenti piattaforma') }}</label>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const toggle = document.getElementById("langToggle");
  const chevron = document.getElementById("langChevron");
  const list = document.getElementById("languageList");

  // ripristina stato da localStorage
  if (localStorage.getItem("langMenuOpen") === "true") {
    list.classList.remove("d-none");
    chevron.classList.remove("bi-chevron-down");
    chevron.classList.add("bi-chevron-up");
  }

  toggle.addEventListener("click", function() {
    list.classList.toggle("d-none");
    chevron.classList.toggle("bi-chevron-down");
    chevron.classList.toggle("bi-chevron-up");

    // salva stato
    localStorage.setItem("langMenuOpen", !list.classList.contains("d-none"));
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const select = document.getElementById("theme");
  const STORAGE_KEY = "theme-preference";

  // Ripristina valore select da localStorage
  const saved = localStorage.getItem(STORAGE_KEY) || "system";
  select.value = saved;

  // Aggiorna localStorage e applica tema subito
  select.addEventListener("change", () => {
    const choice = select.value;
    localStorage.setItem(STORAGE_KEY, choice);

    // trigger manuale cosÃ¬ vedi subito lâ€™effetto senza reload
    document.documentElement.setAttribute("data-theme", choice === "system"
      ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light")
      : choice
    );
  });
});

</script>


{% endblock %}
