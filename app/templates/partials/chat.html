<div id="contacts-panel" class="contacts-panel d-none">
  <div class="contacts-header d-flex justify-content-between align-items-center">
    <span>Messaggi</span>
    <button id="contacts-close" class="btn-close"></button>
  </div>
  <div class="contacts-search">
    <input type="text" id="contacts-search-input" placeholder="Cerca conversazioni...">
  </div>  
  <div id="contacts-list" class="contacts-list"></div>
</div>

<!-- ðŸ”µ Contenitore finestre chat -->
<div id="chat-windows" class="chat-windows"></div>




<!-- ðŸ”µ Script Chat -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { 
  getFirestore, collection, query, orderBy, addDoc, serverTimestamp, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// Config Firebase
const firebaseConfig = { 
   apiKey: "AIzaSyCrtScLAIO77mNN9XA0fuq1QSJS1CtT1V4",
   authDomain: "volontariato-app.firebaseapp.com",
   projectId: "volontariato-app",
   storageBucket: "volontariato-app.firebasestorage.app",
   messagingSenderId: "29025712428",
   appId: "1:29025712428:web:1ed8d7a0f809f130901489",
   measurementId: "G-1ZY30KJ8DN"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const currentUserId = "{{ current_user.id }}";
const currentUserPhoto = "{% if current_user.photo_filename %}{{ url_for('dashboard.static', filename='uploads/profile-photo/' ~ current_user.photo_filename) }}{% else %}{{ url_for('static', filename='img/avatar-placeholder.png') }}{% endif %}";

// Stato notifiche
const unreadCounts = {};
let allUsers = [];      // lista contatti completa
let currentSearch = ""; // filtro ricerca attivo

// Helpers
function getLastRead(userId) {
  return localStorage.getItem("lastRead_" + userId) || "0";
}
function setLastRead(userId, ts) {
  localStorage.setItem("lastRead_" + userId, ts);
  unreadCounts[userId] = 0;
  updateBadge(userId, 0);
  updateGlobalBadge();
}

// Toggle pannello
document.getElementById("chat-toggle").onclick = (e) => {
  e.preventDefault();
  document.getElementById("contacts-panel").classList.toggle("d-none");
  loadContacts();
};
document.getElementById("contacts-close").onclick = () => {
  document.getElementById("contacts-panel").classList.add("d-none");
};

// ðŸ”„ Render lista filtrata
function renderContacts() {
  const list = document.getElementById("contacts-list");
  list.innerHTML = "";

  allUsers
    .filter(u => {
      const name = (u.name || "").toLowerCase();
      const preview = (u.lastMsg || "").toLowerCase();
      return name.includes(currentSearch) || preview.includes(currentSearch);
    })
    .forEach(u => {
      const div = document.createElement("div");
      div.classList.add("contacts-item");
      div.dataset.id = u.id;
      div.dataset.name = u.name;
      div.dataset.photo = u.photo || "/static/img/avatar-placeholder.png";

      div.innerHTML = `
        <img src="${div.dataset.photo}" alt="">
        <div style="flex:1; min-width:0;">
          <div style="font-weight:600;">${u.name}</div>
          <div class="last-msg">
            <span class="msg-preview">${(u.lastMsg || "").slice(0, 25)}${(u.lastMsg || "").length > 25 ? "â€¦" : ""}</span>
            <span class="msg-time-preview">${u.lastTime || ""}</span>
          </div>
        </div>
        <span class="badge"></span>
      `;

      list.appendChild(div);

      // ripristina badge
      if (unreadCounts[u.id]) updateBadge(u.id, unreadCounts[u.id]);
    });
}

// ðŸ”¥ Carica contatti con ultimo messaggio
async function loadContacts() {
  const res = await fetch("/public/api/conversations");
  const users = await res.json();

  allUsers = users;

  allUsers.forEach(u => {
    const convId = [currentUserId, u.id].sort().join("_");
    const qLast = query(collection(db, "conversations", convId, "messages"), orderBy("timestamp", "desc"));
    onSnapshot(qLast, (snapshot) => {
      if (!snapshot.empty) {
        const d = snapshot.docs[0].data();
        u.lastMsg = d.content || "";
        u.lastTime = d.timestamp
          ? new Date(d.timestamp.toMillis()).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})
          : "";
      } else {
        u.lastMsg = "";
        u.lastTime = "";
      }
      renderContacts();
    });
  });
}

// ðŸ” Ricerca conversazioni
const searchInput = document.getElementById("contacts-search-input");
if (searchInput) {
  searchInput.addEventListener("input", (e) => {
    currentSearch = e.target.value.toLowerCase().trim();
    renderContacts();
  });
}

// ðŸ”” Badge notifiche
function updateBadge(userId, count) {
  const item = document.querySelector(`.contacts-item[data-id="${userId}"]`);
  if (!item) return;
  const badge = item.querySelector(".badge");
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = "flex";
  } else {
    badge.style.display = "none";
  }
}
function clearBadge(userId) {
  unreadCounts[userId] = 0;
  updateBadge(userId, 0);
  updateGlobalBadge();
}
function updateGlobalBadge() {
  const total = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
  const badge = document.getElementById("chat-badge");
  if (!badge) return;
  if (total > 0) {
    badge.textContent = total;
    badge.style.display = "flex";
  } else {
    badge.style.display = "none";
  }
}

// ðŸ‘‚ Notifiche
function listenNotifications() {
  fetch("/public/api/conversations").then(r => r.json()).then(users => {
    users.forEach(u => {
      const convId = [currentUserId, u.id].sort().join("_");
      const q = query(collection(db, "conversations", convId, "messages"), orderBy("timestamp", "asc"));
      onSnapshot(q, (snapshot) => {
        if (snapshot.empty) return;
        const lastRead = parseInt(getLastRead(u.id), 10);
        let unread = 0;
        snapshot.forEach(doc => {
          const d = doc.data();
          const ts = d.timestamp ? d.timestamp.toMillis() : 0;
          if (ts > lastRead && d.senderId !== currentUserId) unread++;
        });
        unreadCounts[u.id] = unread;
        if (!document.getElementById("chat_" + u.id)) updateBadge(u.id, unread);
        else clearBadge(u.id);
        updateGlobalBadge();
      });
    });
  });
}

// ðŸ‘† Apri chat
document.addEventListener("click", (e) => {
  const item = e.target.closest(".contacts-item");
  if (item) openChatWindow(item.dataset.id, item.dataset.name, item.dataset.photo);
});

window.openChatWindow = function(userId, userName, photo) {
  const winId = "chat_" + userId;
  if (document.getElementById(winId)) {
    clearBadge(userId);
    setLastRead(userId, Date.now());
    return;
  }

  const container = document.getElementById("chat-windows");
  const div = document.createElement("div");
  div.classList.add("chat-window");
  div.id = winId;
  div.innerHTML = `
    <div class="chat-header">
      <span><img src="${photo}" style="width:20px;height:20px;border-radius:50%;margin-right:5px;"> ${userName}</span>
      <button class="btn-close btn-sm"></button>
    </div>
    <div class="chat-messages" id="msgs_${userId}"></div>
    <div class="chat-input">
      <input type="text" id="input_${userId}" placeholder="Scrivi...">
      <button id="send_${userId}">âž¤</button>
    </div>
  `;
  container.appendChild(div);

  div.querySelector(".btn-close").onclick = () => div.remove();
  clearBadge(userId);
  setLastRead(userId, Date.now());

  const msgsDiv = div.querySelector(".chat-messages");
  const convId = [currentUserId, userId].sort().join("_");

  // ðŸ‘‡ Legge TUTTI i messaggi
  const q = query(
    collection(db, "conversations", convId, "messages"),
    orderBy("timestamp", "asc")
  );

  onSnapshot(q, (snapshot) => {
    const docs = snapshot.docs.map(doc => {
      const d = doc.data();
      return {
        id: doc.id,
        senderId: d.senderId,
        content: d.content,
        timestamp: d.timestamp ? d.timestamp.toMillis() : 0
      };
    });

    // ðŸ”„ Se qualche messaggio non ha timestamp â†’ li metto in coda ordinando per id
    docs.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

    msgsDiv.innerHTML = "";
    let lastSender = null;
    let lastDate = null;
    let latestTs = 0;

    docs.forEach(d => {
      if (d.timestamp > latestTs) latestTs = d.timestamp;

      const msgDate = d.timestamp
        ? new Date(d.timestamp).toLocaleDateString()
        : "Senza data";

      if (lastDate !== msgDate) {
        const sep = document.createElement("div");
        sep.classList.add("date-separator");
        sep.textContent = msgDate;
        msgsDiv.appendChild(sep);
        lastDate = msgDate;
      }

      const row = document.createElement("div");
      row.classList.add("message-row");

      const bubble = document.createElement("div");
      bubble.classList.add("message", d.senderId == currentUserId ? "sent" : "received");

      const text = document.createElement("span");
      text.textContent = d.content;
      bubble.appendChild(text);

      if (d.timestamp) {
        const timeSpan = document.createElement("span");
        timeSpan.classList.add("msg-time");
        timeSpan.textContent = new Date(d.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        bubble.appendChild(timeSpan);
      }

      bubble.addEventListener("click", () => bubble.classList.toggle("show-time"));
      bubble.addEventListener("mouseleave", () => bubble.classList.remove("show-time"));

      if (d.senderId !== lastSender) {
        const avatar = document.createElement("img");
        avatar.src = (d.senderId == currentUserId) ? currentUserPhoto : photo;
        if (d.senderId == currentUserId) {
          row.appendChild(bubble);
          row.appendChild(avatar);
        } else {
          row.appendChild(avatar);
          row.appendChild(bubble);
        }
      } else {
        const placeholder = document.createElement("div");
        placeholder.classList.add("avatar-placeholder");
        if (d.senderId == currentUserId) {
          row.appendChild(bubble);
          row.appendChild(placeholder);
        } else {
          row.appendChild(placeholder);
          row.appendChild(bubble);
        }
      }

      msgsDiv.appendChild(row);
      lastSender = d.senderId;
    });

    if (latestTs > 0) setLastRead(userId, latestTs);

    // ðŸ‘‡ autoscroll
    msgsDiv.scrollTop = msgsDiv.scrollHeight;
  });

  const input = div.querySelector("#input_" + userId);
  const send = div.querySelector("#send_" + userId);

  function sendMessage() {
    if (!input.value.trim()) return;
    addDoc(collection(db, "conversations", convId, "messages"), {
      senderId: currentUserId,
      content: input.value,
      timestamp: serverTimestamp()
    });
    input.value = "";
    setTimeout(() => { msgsDiv.scrollTop = msgsDiv.scrollHeight; }, 100);
  }

  send.onclick = sendMessage;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });
};

document.addEventListener("click", (e) => {
  const btn = e.target.closest("#start-chat-btn");
  if (btn) {
    const userId = btn.dataset.userId;
    const userName = btn.dataset.userName;
    const photo = btn.dataset.userPhoto;

    fetch(`/public/api/start_chat/${userId}`, {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        openChatWindow(userId, userName, photo);
      } else {
        alert(data.error || "Errore nell'avvio della chat");
      }
    });
  }
});



// ðŸš€ Avvio
loadContacts();
listenNotifications();

</script>
